<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="challenge">
	
	<insert id="challengeInsert" parameterType="com.a.dto.challengeDto">
		
		INSERT INTO CHALLENGE(CHALLENGESEQ, CATEGORY, CHALLENGETITLE, CHALLENGETEXT,CHALLENGESTART, CHALLENGEEND,CHALLENGEPERIOD,
						IDENTIFYFREQUENCY, IDENTIFYDAY, IDENTIFYTIME, CHALLENGEPHOTO, CHALLENGESAVEPHOTO, CERTIFYPHOTO, CERTIFYSAVEPHOTO, CERTIFY, RATINGAVG, CHALLENGESTOP, CHALLENGEDEL, 
						HEADERNUM, POINTCOUNT, CHALLENGEMEMBER, EMAIL)
		VALUES(CHAL_SEQ.NEXTVAL, #{category}, #{challengetitle}, #{challengetext}, #{challengestart}, #{challengeend}, #{challengeperiod}, 
				#{identifyfrequency}, #{identifyday}, #{identifytime}, #{challengephoto}, #{challengesavephoto}, #{certifyphoto}, #{certifysavephoto},#{certify}, 0.0, 0, 0,
				(SELECT AUTH FROM MEMBER WHERE EMAIL = #{email}), #{pointcount}, 0, #{email})
		
	</insert>
	
	<!-- hotChallengeData 데이터 전부 가져오기 java.util.Map(param은 start end search category   -->
	<select id="hotChallengeData" parameterType="java.util.Map" resultType="com.a.util.lowerKeyMap">
	 	SELECT CHALLENGESEQ, CATEGORY, CHALLENGETITLE, CHALLENGETEXT, CHALLENGESTART, CHALLENGEEND, CHALLENGEPERIOD,
	 			  IDENTIFYFREQUENCY, IDENTIFYDAY, IDENTIFYTIME, CHALLENGEPHOTO, CHALLENGESAVEPHOTO, RATINGAVG, HEADERNUM, POINTCOUNT, CHALLENGEMEMBER, EMAIL,
	 			  NICKNAME, AUTH, MEMBERPHOTO
	 	FROM (SELECT ROW_NUMBER()OVER(ORDER BY CHALLENGEMEMBER DESC) AS RNUM,
				CHALLENGESEQ, CATEGORY, CHALLENGETITLE, CHALLENGETEXT, CHALLENGESTART, CHALLENGEEND, CHALLENGEPERIOD,
	 			IDENTIFYFREQUENCY, IDENTIFYDAY, IDENTIFYTIME, CHALLENGEPHOTO, CHALLENGESAVEPHOTO, RATINGAVG, HEADERNUM, POINTCOUNT, CHALLENGEMEMBER, C.EMAIL,
	 			 M.NICKNAME, M.AUTH, M.MEMBERPHOTO
	  		  FROM CHALLENGE C, MEMBER M
	  		  WHERE 1=1 
	  		  		AND C.EMAIL = M.EMAIL
		  		  		AND CHALLENGESTOP = 0 
		  		  			AND CHALLENGEDEL = 0
		  		  				<if test="category != 0"><!-- 안전성을 고려 -->
				  					AND CATEGORY = ${category}
				  				</if>
					  		  	 	<if test="search != null and search != ''"><!-- 안전성을 고려 -->
						  				 AND CHALLENGETITLE LIKE '%'||#{search}||'%'		  
					  				</if>
			  ORDER BY CHALLENGEMEMBER DESC, CHALLENGESTART DESC) 
	 	WHERE RNUM BETWEEN ${startPage} AND ${endPage}
	</select>
	
	<!-- challengeDataCount 글의 총 수 가져오기 paramMap search / category-->
	<select id="challengeDataCount" parameterType="java.util.Map" resultType="java.lang.Integer">
	 	SELECT NVL(COUNT(*), 0)
	 	FROM CHALLENGE
	  	WHERE 1=1 
	  		AND CHALLENGESTOP = 0 
	  			AND CHALLENGEDEL = 0
	  				<if test="category != 0"><!-- 안전성을 고려 -->
	  					AND CATEGORY = ${category}
	  				</if>
					  	 <if test="search != null and search != ''"><!-- 안전성을 고려 -->
			 				 AND CHALLENGETITLE LIKE '%'||#{search}||'%'		  
						</if>
	</select>
	
	<!-- 생성한 멤버의 데이터 가져오기 -->
	<select id="createChallengeMember"  parameterType="java.lang.String" resultType="com.a.util.lowerKeyMap">
		SELECT C.CHALLENGESEQ, M.EMAIL, M.NICKNAME, M.AUTH, M.MEMBERPHOTONAME, M.POINT 
		FROM CHALLENGE C, MEMBER M
		WHERE C.EMAIL = M.EMAIL
			AND C.EMAIL = #{email}
	</select>
	
	<!-- 챌린지 한개 가져오기 challengeDetail //parameter : challengeseq -->
	<select id="challengeDetail" parameterType="java.lang.Integer" resultType="com.a.dto.challengeDto">
		SELECT CHALLENGESEQ, CATEGORY, CHALLENGETITLE, CHALLENGETEXT, CHALLENGESTART, CHALLENGEEND, CHALLENGEPERIOD, IDENTIFYFREQUENCY,
				IDENTIFYDAY, IDENTIFYTIME, CHALLENGESAVEPHOTO, CERTIFYSAVEPHOTO, CERTIFY, RATINGAVG, POINTCOUNT, EMAIL
		FROM CHALLENGE
		WHERE CHALLENGESEQ = #{challengeseq}
	</select>
	
	<!-- 챌린지 찜하기 challengelikeInsert -->
	<insert id="challengelikeInsert" parameterType="java.util.Map">
		INSERT INTO CHALLENGEWISH(WISHSEQ, WISH, CHALLENGESEQ, EMAIL)
		VALUES(WISH_SEQ.NEXTVAL, 1, #{challengeseq}, #{email})
	</insert>
	
	<!-- 챌린지 찜하기 challengelikeDelete -->
	<delete id="challengelikeDelete"  parameterType="java.util.Map">
		DELETE FROM CHALLENGEWISH
		WHERE CHALLENGESEQ = #{challengeseq}
			AND EMAIL =  #{email}
	</delete>
	
	<!-- 챌린지 찜하기 내데이터 가져오기 challengelikeSeq -->
	<select id="challengelikeSeq" parameterType="java.util.Map" resultType="com.a.util.lowerKeyMap">
		SELECT WISHSEQ, WISH, CHALLENGESEQ, EMAIL
		FROM CHALLENGEWISH
		WHERE EMAIL=#{email} AND CHALLENGESEQ = #{challengeseq}	
	</select>
	
	<!-- 세션에 담긴 한사람 데이터가져오기 -->
	<select id="userData" parameterType="java.lang.String" resultType="com.a.dto.MemberDto">
		SELECT *
		FROM MEMBER
		WHERE EMAIL = #{email}
	</select>
	
	<!-- 챌린지 멤버 insert challengeMemberInsert -->
	<insert id="challengeMemberInsert" parameterType="java.util.Map">
		INSERT INTO CHALLENGEMEMBER(CHALLENGMEMSEQ, IDENTIFY, CHALLENGESEQ, EMAIL)
		VALUES(CHALMEM_SEQ.NEXTVAL, 0, #{challengeseq}, #{email})
	</insert>
	
	<!-- 챌린지 가입 시 포인트 차감memberPointReducation -->
	<update id="memberPointReducation" parameterType="java.util.Map">
		UPDATE MEMBER
		SET POINT = POINT-${point}
		WHERE EMAIL = #{email}	
	</update>
	
	<!-- 해당 챌린지 가입한 사람 본인 challengeMember -->
	<select id="challengeMember" parameterType="java.util.Map" resultType="com.a.util.lowerKeyMap">
		SELECT *
		FROM CHALLENGEMEMBER
		WHERE EMAIL = #{email} AND CHALLENGESEQ = #{challengeseq}
	</select>
	
	<!-- 챌린지 멤버 수 증가시키기 -->
	<update id="challengeMemberCountUp" parameterType="java.util.Map">
		UPDATE CHALLENGE
		SET CHALLENGEMEMBER = ${challengemember)+1
		WHERE CHALLENGESEQ = #{challengeseq}	
	</update>

</mapper>